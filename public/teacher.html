<!DOCTYPE html>
<html>
<head>
    <title>Teacher Control Center</title>
    <style>
        /* Kahoot-inspired Bold Theme */
        body { font-family: 'Arial Black', sans-serif; background: #250850; color: white; text-align: center; padding: 20px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 24px; backdrop-filter: blur(15px); width: 90%; max-width: 900px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-top: 20px; }
        
        /* Typography & Buttons */
        h1 { font-size: 2.5rem; text-shadow: 2px 2px #000; margin-bottom: 20px; }
        .btn { padding: 18px 35px; border-radius: 50px; border: none; cursor: pointer; font-size: 1.2rem; font-weight: bold; margin: 10px; transition: transform 0.2s, background 0.2s; color: white; box-shadow: 0 5px 0 rgba(0,0,0,0.2); }
        .btn:active { transform: translateY(3px); box-shadow: none; }
        .btn-green { background: #26890c; } .btn-blue { background: #1368ce; } .btn-gold { background: #d89e00; color: #250850; }
        .btn-gray { background: #555; }

        /* Lobby & Students */
        #qr { background: white; padding: 15px; border-radius: 12px; margin: 20px 0; }
        .pill { background: white; color: #250850; padding: 10px 22px; border-radius: 50px; display: inline-block; margin: 8px; font-family: sans-serif; font-weight: 800; font-size: 1.1rem; animation: popIn 0.3s ease-out; }

        /* Progress Bar */
        .progress-wrapper { margin: 30px auto; width: 80%; background: rgba(255,255,255,0.2); border-radius: 50px; height: 35px; overflow: hidden; position: relative; border: 3px solid white; }
        #progress-bar { background: #26890c; height: 100%; width: 0%; transition: width 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        #progress-text { margin-top: 10px; font-size: 1.2rem; font-family: sans-serif; }

        /* Answer Reveal Box */
        #answer-reveal { background: #1368ce; padding: 25px; border-radius: 15px; display: none; margin: 25px 0; border: 4px solid white; font-size: 1.8rem; }

        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-lobby">
            <h1>Join the Quiz!</h1>
            <canvas id="qr"></canvas>
            <p style="font-size: 1.2rem;">Go to: <span id="url-display" style="color: #00d4ff;"></span></p>
            
            <div id="student-list" style="min-height: 100px; margin: 20px 0;">
                </div>

            <div style="margin-top: 30px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 20px;">
                <button class="btn btn-green" onclick="startGame()">START GAME</button>
                <button class="btn btn-blue" onclick="location.href='/editor.html'">EDIT QUESTIONS</button>
            </div>
        </div>

        <div id="view-game" style="display:none">
            <h1 id="q-text">Loading Question...</h1>
            
            <div class="progress-wrapper">
                <div id="progress-bar"></div>
            </div>
            <p id="progress-text">0 / 0 Students Finished</p>

            <div id="answer-reveal"></div>

            <div style="margin-top: 40px;">
                <button class="btn btn-gold" id="reveal-btn" onclick="reveal()">SHOW ANSWER</button>
                <button class="btn btn-green" onclick="nextQuestion()">NEXT QUESTION</button>
            </div>
        </div>

        <div id="view-results" style="display:none">
            <h1>üèÜ Leaderboard</h1>
            <div id="leaderboard-list" style="text-align: left; max-width: 500px; margin: auto;"></div>
            
            <div style="margin-top: 40px;">
                <button class="btn btn-gray" onclick="downloadResponses()">üì• DOWNLOAD FREE RESPONSES</button>
                <button class="btn btn-blue" onclick="location.reload()">PLAY AGAIN</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script>
        const socket = io();
        let currentCorrect = "";

        // Setup QR and URL
        const liveUrl = window.location.origin;
        document.getElementById('url-display').innerText = liveUrl;
        QRCode.toCanvas(document.getElementById('qr'), liveUrl, { width: 250, margin: 2 });

        // --- Socket Listeners ---

        socket.on('updateStudentList', (names) => {
            const container = document.getElementById('student-list');
            container.innerHTML = names.map(n => `<span class="pill">${n}</span>`).join('');
        });

        socket.on('answerCountUpdate', (data) => {
            const percent = data.total > 0 ? (data.received / data.total) * 100 : 0;
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-text').innerText = `${data.received} / ${data.total} Students Answered`;
        });

        socket.on('newQuestion', (q) => {
            document.getElementById('q-text').innerText = q.q;
            // Note: In a cloud environment, you might want the server to send the 'correct' 
            // field only to the teacher. For this setup, we assume the teacher knows or it's stored.
            currentCorrect = q.correct || "See your question list"; 
            document.getElementById('answer-reveal').style.display = 'none';
        });

        socket.on('gameFinished', (board) => {
            showView('view-results');
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = board.map((s, i) => `
                <div style="display:flex; justify-content:space-between; background:white; color:#250850; padding:15px; margin:10px 0; border-radius:10px; font-weight:bold;">
                    <span>${i+1}. ${s.name}</span>
                    <span>${s.score} pts</span>
                </div>
            `).join('');
        });

        // --- Functions ---

        function showView(id) {
            ['view-lobby', 'view-game', 'view-results'].forEach(v => {
                document.getElementById(v).style.display = (v === id) ? 'block' : 'none';
            });
        }

        function startGame() {
            showView('view-game');
            nextQuestion();
        }

        function nextQuestion() {
            socket.emit('nextQuestion');
        }

        function reveal() {
            const box = document.getElementById('answer-reveal');
            box.innerText = "Correct: " + currentCorrect;
            box.style.display = 'block';
        }

        function downloadResponses() {
            fetch('/get-logs')
                .then(res => res.text())
                .then(text => {
                    const blob = new Blob([text], { type: "text/plain" });
                    const a = document.createElement('a');
                    a.href = URL.createObjectURL(blob);
                    a.download = "quiz_results_log.txt";
                    a.click();
                });
        }
    </script>
</body>
</html>