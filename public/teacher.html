<!DOCTYPE html>
<html>
<head>
    <title>Teacher Control Center</title>
    <style>
        body { font-family: 'Arial Black', sans-serif; background: #250850; color: white; text-align: center; padding: 20px; margin: 0; min-height: 100vh; display: flex; flex-direction: column; align-items: center; }
        .container { background: rgba(255,255,255,0.1); padding: 40px; border-radius: 24px; backdrop-filter: blur(15px); width: 90%; max-width: 900px; box-shadow: 0 15px 35px rgba(0,0,0,0.4); margin-top: 20px; }
        h1 { font-size: 2.5rem; text-shadow: 2px 2px #000; }
        .btn { padding: 18px 35px; border-radius: 50px; border: none; cursor: pointer; font-size: 1.2rem; font-weight: bold; margin: 10px; color: white; }
        .btn-green { background: #26890c; } .btn-blue { background: #1368ce; } .btn-gold { background: #d89e00; color: #250850; } .btn-gray { background: #555; }
        #qr { background: white; padding: 15px; border-radius: 12px; margin: 20px 0; }
        .pill { background: white; color: #250850; padding: 10px 22px; border-radius: 50px; display: inline-block; margin: 8px; font-family: sans-serif; font-weight: 800; }
        .progress-wrapper { margin: 30px auto; width: 80%; background: rgba(255,255,255,0.2); border-radius: 50px; height: 35px; overflow: hidden; border: 3px solid white; }
        #progress-bar { background: #26890c; height: 100%; width: 0%; transition: width 0.4s ease; }
        #answer-reveal { background: #1368ce; padding: 25px; border-radius: 15px; display: none; margin: 25px 0; border: 4px solid white; font-size: 1.8rem; }
        .review-card { background: rgba(255,255,255,0.2); padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 8px solid #26890c; text-align: left; }
    </style>
</head>
<body>

    <div class="container">
        <div id="view-lobby">
            <h1>Join the Quiz!</h1>
            <canvas id="qr"></canvas>
            <p>Go to: <span id="url-display" style="color: #00d4ff;"></span></p>
            <div id="student-list"></div>
            <div style="margin-top: 30px;">
                <button class="btn btn-green" onclick="startGame()">START GAME</button>
                <button class="btn btn-blue" onclick="location.href='/editor.html'">EDIT QUESTIONS</button>
            </div>
        </div>

        <div id="view-game" style="display:none">
            <h1 id="q-text">Loading Question...</h1>
            <div class="progress-wrapper"><div id="progress-bar"></div></div>
            <p id="progress-text">0 / 0 Students Finished</p>
            <div id="answer-reveal"></div>
            <div style="margin-top: 40px;">
                <button class="btn btn-gold" onclick="reveal()">SHOW ANSWER</button>
                <button class="btn btn-green" onclick="nextQuestion()">NEXT QUESTION</button>
            </div>
        </div>

        <div id="view-results" style="display:none">
            <div id="leaderboard-list"></div>
            <div id="detailed-review"></div>
            <div style="margin-top: 40px;">
                <button class="btn btn-gray" onclick="downloadResponses()">üì• EXPORT LOGS</button>
                <button class="btn btn-blue" onclick="location.reload()">RESTART</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.4.4/build/qrcode.min.js"></script>
    <script>
        const socket = io();
        let currentCorrect = "";

        document.getElementById('url-display').innerText = window.location.origin;
        QRCode.toCanvas(document.getElementById('qr'), window.location.origin, { width: 250 });

        socket.on('updateStudentList', (names) => {
            document.getElementById('student-list').innerHTML = names.map(n => `
                <div class="pill">${n} <span onclick="kick('${n}')" style="margin-left:10px; color:#e21b3c; cursor:pointer;">√ó</span></div>
            `).join('');
        });

        function kick(name) {
            if (confirm(`Remove ${name}?`)) socket.emit('kickStudent', name);
        }

        socket.on('answerCountUpdate', (data) => {
            const percent = data.total > 0 ? (data.received / data.total) * 100 : 0;
            document.getElementById('progress-bar').style.width = percent + "%";
            document.getElementById('progress-text').innerText = `${data.received} / ${data.total} Students Answered`;
        });

        socket.on('newQuestion', (q) => {
            document.getElementById('q-text').innerText = q.q;
            currentCorrect = q.correct || "Check Question List";
            document.getElementById('answer-reveal').style.display = 'none';
        });

        socket.on('gameFinished', (data) => {
            document.getElementById('view-game').style.display = 'none';
            document.getElementById('view-results').style.display = 'block';
            
            // 1. Leaderboard
            const lb = document.getElementById('leaderboard-list');
            lb.innerHTML = `<h1>üèÜ Leaderboard</h1>` + data.leaderboard.map((s, i) => `
                <div style="display:flex; justify-content:space-between; background:white; color:#250850; padding:15px; margin:10px 0; border-radius:10px; font-weight:bold;">
                    <span>${i+1}. ${s.name}</span><span>${s.score} pts</span>
                </div>
            `).join('');

            // 2. Toughest Question
            let toughest = { index: -1, count: Infinity };
            data.questions.forEach((q, i) => {
                if (q.type === 'FR') return;
                const score = data.reviewData[i] ? data.reviewData[i].length : 0;
                if (score < toughest.count) { toughest.count = score; toughest.index = i; }
            });

            const review = document.getElementById('detailed-review');
            review.innerHTML = "";
            if (toughest.index !== -1) {
                const tq = data.questions[toughest.index];
                review.innerHTML = `
                    <div style="background:#e21b3c; padding:25px; border-radius:15px; margin-top:40px; border:4px solid white; text-align:left;">
                        <h2 style="margin:0;">üî• Toughest Question</h2>
                        <p><strong>${tq.q}</strong></p>
                        <p>Only ${toughest.count} students got this right.</p>
                    </div>
                `;
            }

            // 3. Question Breakdown
            review.innerHTML += `<h2>üìù Question Review</h2>`;
            data.questions.forEach((q, i) => {
                const correctOnes = data.reviewData[i] || [];
                review.innerHTML += `
                    <div class="review-card">
                        <p><strong>Q${i+1}: ${q.q}</strong></p>
                        <p style="color:#00d4ff;">Correct: ${q.correct}</p>
                        <p style="font-size:0.9rem;">Correct Students (${correctOnes.length}): ${correctOnes.join(', ') || 'None'}</p>
                    </div>
                `;
            });
        });

        function startGame() { document.getElementById('view-lobby').style.display='none'; nextQuestion(); }
        function nextQuestion() { document.getElementById('view-game').style.display='block'; socket.emit('nextQuestion'); }
        function reveal() { 
            const box = document.getElementById('answer-reveal');
            box.innerText = "Correct: " + currentCorrect;
            box.style.display = 'block';
        }

        function downloadResponses() {
            fetch('/get-logs').then(r => r.text()).then(t => {
                const blob = new Blob([t], {type: "text/plain"});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = "quiz_logs.txt";
                a.click();
            });
        }
    </script>
</body>
</html>